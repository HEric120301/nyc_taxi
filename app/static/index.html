<!DOCTYPE html>
<html>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<body>

<div ng-app="myApp" ng-controller="myCtrl"> 

<p>Todsay's welcome message is:</p>

<h1>{{myWelcome}}</h1>

</div>

<p>The $http service requests a page on the server, and the response is set as the value of the "myWelcome" variable.</p>

<script>
	var app = angular.module('myApp', []);
	app.controller('myCtrl', function($scope, $http) {
	    $http.post('/test')
	    	.then(function(response) {
		        $scope.myWelcome = response.data['s'];
		    })
		});

	var dataset = []

	d3.csv('dataset.csv', function(prices) {
        var i=0
		dataset = prices.map(d=>{
            var val = Number(d['2016 [YR2016]'])
            var country = d['Country Name']
            if(val!='') {
                i += 1
                return [val, country]
            }
		})
        //delete empty rows
        dataset = dataset.slice(0, i)

        //stem-and-leaf plot
        stem_len = 0
        stem_data = dataset.map(d=>{
            var num = Math.round(d[0]);
            var first_digit = (num+'')[0]
            stem_len = Number(first_digit)>stem_len?Number(first_digit):stem_len
            var rest_digit = (num+'').slice(1)
            return [first_digit, rest_digit]
        })
        stem_dataset = []
        for(var i=0; i<stem_data.length; i++) {
            var arr = stem_dataset[stem_data[i][0]]            
            if(arr == undefined) stem_dataset[stem_data[i][0]] = stem_data[i][1]
            else stem_dataset[stem_data[i][0]] += (stem_data[i][1])
        }
        stem_dataset = stem_dataset.slice(1,stem_dataset.length)

        for(var i=1; i<stem_len; i++) {
            if (stem_dataset[i] == undefined) {stem_dataset[i]=''}
        }
        
        d3.select('body').append('p').html('1.stem_leaf plot')
        var w = 1000, h = 400, indent_x = 80, indent_y=20;
        var svg = d3.select('body')  //create <svg>
            .append('svg')
            .attr('width', w)
            .attr('height', h);
        svg.selectAll('text.s')  
            .data(stem_dataset)
            .enter()
            .append('text')
            .text((d,i)=>{return i+1})
            .attr('x', d=>{return indent_x })
            .attr('y', (d,i)=>{ return indent_y+i * h/stem_len})
            .style('class', 's')
            .style('fill', 'black')
            .style('opacity', 0.5);
        svg.selectAll('text.t')  
            .data(stem_dataset)
            .enter()
            .append('text')
            .text((d,i)=>{return d})
            .attr('x', d=>{return 40+indent_x})
            .attr('y', (d,i)=>{ return indent_y+i * h/stem_len})
            .style('class', 's')
            .style('fill', 'black')
            .style('opacity', 0.5);
        svg.append('line')
            .attr('x1', 25+indent_x)
            .attr('y1', indent_y-20)
            .attr('x2', 25+indent_x)
            .attr('y2', indent_y+h)
            .style('stroke', 'black')
            .style('stroke-width', 2)

        //bar chart
        d3.select('body').append('p').html('2.bar chart')
        var w = 1000, h = 200, pad = 4;
        var svg = d3.select('body')  //create <svg>
            .append('svg')
            .attr('width', w)
            .attr('height', h);
        svg.selectAll('rect')  //draw <rect>
            .data(dataset)
            .enter()
            .append('rect')
            .attr('x', (d,i)=>{ return indent_x/2+i * ((w-indent_x) / dataset.length); })
            .attr('y', d=>{ return h - d[0]; })
            .attr('width', (w-indent_x) / dataset.length - pad)
            .attr('height', d=>{ return d[0]; })
            .style('fill', 'blue')
            .style('opacity', 0.5);
        svg.selectAll('text')  //draw <text>
            .data(dataset)
            .enter()
            .append('text')
            .text(d=>{ return d[1]})
            .attr('x', (d,i)=>{ return indent_x/2+i * ((w-indent_x) / dataset.length) + ((w-indent_x) / dataset.length - pad) / 2; })
            .attr('y', d=>{ return h - d[0]-4; })
            .style('fill', 'black')
            .style('font-size', '10px')
            .style('text-anchor', 'middle');   

        //scatter plot
        d3.select('body').append('p').html('3.scatter plot')
        var w = 1000, h = 150, pad = 4;
        var svg = d3.select('body')  //create <svg>
            .append('svg')
            .attr('width', w)
            .attr('height', h);
        svg.selectAll('circle')  //draw <circle>
            .data(dataset)
            .enter()
            .append('circle')
            .attr('cx', (d,i)=>{ return indent_x/2+i * ((w-indent_x) / dataset.length); })
            .attr('cy', d=>{ return h - d[0]; })
            .attr('r', 5)
            .style('fill', d=>{ return 'red'; })
            .style('opacity', 0.5);
        svg.selectAll('text')  //draw <text>
            .data(dataset)
            .enter()
            .append('text')
            .text(d=>{ return d[1]; })
            .attr('x', (d,i)=>{ return indent_x/2 + i * ((w-indent_x) / dataset.length) + ((w-indent_x) / dataset.length - pad) / 2; })
            .attr('y', d=>{ return h - d[0]; })
            .style('fill', 'black')
            .style('font-size', '10px')
            .style('text-anchor', 'middle');   

    })

</script>

</body>
</html>
